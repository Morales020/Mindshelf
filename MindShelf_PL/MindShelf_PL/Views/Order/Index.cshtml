@model IEnumerable<MindShelf_BL.Dtos.OrderDtos.OrderResponseDto>
@using MindShelf_DAL.Models

@{
	ViewData["Title"] = "قائمة الطلبات";
	var statusFilter = ViewBag.StatusFilter as string;
	var searchQuery = ViewBag.SearchQuery as string;
	var fromDate = ViewBag.FromDate as string;
	var toDate = ViewBag.ToDate as string;
	int totalPages = ViewBag.TotalPages ?? 1;
	int currentPage = ViewBag.CurrentPage ?? 1;
}

<style>
	/* Dark Mode Styles for Order Index */
	body.dark-mode .modal-content {
		background-color: var(--dark-card-bg);
		border-color: var(--dark-border-color);
	}

	body.dark-mode .modal-body {
		color: var(--dark-text-primary);
	}

	body.dark-mode .modal-body p {
		color: var(--dark-text-primary);
	}

	body.dark-mode .modal-body strong {
		color: var(--dark-text-primary);
	}

	body.dark-mode .modal-footer {
		border-color: var(--dark-border-color);
	}

</style>

<div class="card shadow-sm mt-4">
	<div class="card-header text-white">
		<h3 class="mb-3 mt-3">
			<i class="fas fa-shopping-cart me-2"></i>
			طلباتي
		</h3>
	</div>
	<div class="card-body">

		<!-- Success / Error Alerts -->
		@if (TempData["Message"] != null)
		{
			<div class="alert alert-success alert-dismissible fade show" role="alert">
				<i class="fas fa-check-circle me-2"></i>@TempData["Message"]
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
			</div>
		}
		@if (TempData["Error"] != null)
		{
			<div class="alert alert-danger alert-dismissible fade show" role="alert">
				<i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
				<button type="button" class="btn-close" data-bs-dismiss="alert"></button>
			</div>
		}

		<!-- Filters -->
		<!-- Filters -->
		<form method="get" class="row g-3 mb-4 align-items-end">
			<div class="col-md-3">
				<label class="form-label">الحالة</label>
				<select name="status" class="form-select">
					<option value="">جميع الحالات</option>
					@foreach (OrderState state in Enum.GetValues(typeof(OrderState)))
					{
						<option value="@state" selected="@(ViewBag.StatusFilter == state.ToString())">
							@GetStatusText(state)
						</option>
					}
				</select>
			</div>

			<div class="col-md-3">
				<label class="form-label">من تاريخ</label>
				<input type="date" name="fromDate" class="form-control" value="@fromDate" />
			</div>

			<div class="col-md-3">
				<label class="form-label">إلى تاريخ</label>
				<input type="date" name="toDate" class="form-control" value="@toDate" />
			</div>

			<div class="col-md-3 d-flex">
				<button type="submit" class="btn btn-primary me-2">
					<i class="fas fa-filter me-1"></i> تطبيق الفلتر
				</button>
				<a asp-action="Index" class="btn btn-outline-secondary">
					<i class="fas fa-undo me-1"></i> إعادة تعيين
				</a>
			</div>
		</form>

		<!-- Orders Table -->
		@if (Model != null && Model.Any())
		{
			<div class="table-responsive">
				<table class="table table-hover align-middle text-center">
					<thead class="table-light">
						<tr>
							<th>رقم الطلب</th>
							<th>العميل</th>
							<th>المجموع</th>
							<th>الحالة</th>
							<th>التاريخ</th>
							<th>الإجراءات</th>
						</tr>
					</thead>
					<tbody>
						@foreach (var order in Model)
						{
							<tr>
								<td>@order.Id.ToString("D6")</td>
								<td>@order.UserName</td>
								<td class="fw-bold">@order.TotalAmount.ToString("C")</td>
								<td>
									<span class="badge @GetStatusBadgeClass(order.OrderStatus)">
										@GetStatusText(order.OrderStatus)
									</span>
								</td>
								<td>@order.OrderDate.ToString("yyyy/MM/dd HH:mm")</td>
								<td>
									<div class="btn-group btn-group-sm gap-1">
										<a asp-action="Details" asp-route-id="@order.Id" class="btn btn-outline-primary">
											<i class="fas fa-eye"></i>
										</a>
										@if (User.IsInRole("Admin"))
										{
											<a asp-action="EditStatus" asp-route-id="@order.Id" class="btn btn-outline-secondary ">
												<i class="fas fa-edit"></i>
											</a>
											@if (order.OrderStatus != MindShelf_DAL.Models.OrderState.Confirmed && 
												 order.OrderStatus != MindShelf_DAL.Models.OrderState.Shipping && 
												 order.OrderStatus != MindShelf_DAL.Models.OrderState.Delivered)
											{
												<button type="button"
														class="btn btn-danger"
														data-bs-toggle="modal"
														data-bs-target="#deleteModal"
														data-order-id="@order.Id"
														data-order-user="@order.UserName">
													<i class="fas fa-trash-alt"></i>
												</button>
											}
											else
											{
												<button type="button" class="btn btn-outline-secondary" disabled title="لا يمكن حذف الطلبات المؤكدة أو المشحونة أو المسلمة">
													<i class="fas fa-lock"></i>
												</button>
											}
										}
									</div>
								</td>
							</tr>
						}
					</tbody>
				</table>
			</div>

			<!-- Pagination -->
			<nav class="mt-4">
				<ul class="pagination justify-content-center">
					<li class="page-item @(currentPage == 1 ? "disabled" : "")">
						<a class="page-link" href="@Url.Action("Index", new { pageNumber = currentPage - 1, status = statusFilter, search = searchQuery })">السابق</a>
					</li>
					@for (int i = 1; i <= totalPages; i++)
					{
						<li class="page-item @(i == currentPage ? "active" : "")">
							<a class="page-link" href="@Url.Action("Index", new { pageNumber = i, status = statusFilter, search = searchQuery })">@i</a>
						</li>
					}
					<li class="page-item @(currentPage == totalPages ? "disabled" : "")">
						<a class="page-link" href="@Url.Action("Index", new { pageNumber = currentPage + 1, status = statusFilter, search = searchQuery })">التالي</a>
					</li>
				</ul>
			</nav>
		}
		else
		{
			<div class="text-center py-5 text-muted">
				<i class="fas fa-box fa-4x mb-3"></i>
				<h5>لا توجد طلبات</h5>
			</div>
		}
	</div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
			<div class="modal-header bg-danger text-white">
				<h5 class="modal-title" id="deleteModalLabel"><i class="fas fa-trash-alt me-2"></i>تأكيد الحذف</h5>
				<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="إغلاق"></button>
			</div>
			<div class="modal-body">
				<p>هل أنت متأكد أنك تريد حذف الطلب <span id="deleteOrderId"></span> للعميل <strong id="deleteOrderUser"></strong>؟</p>
			</div>
			<div class="modal-footer">
				<form id="deleteForm" method="post">
					<input type="hidden" name="id" id="deleteInputId" />
					<button type="submit" class="btn btn-danger">
						<i class="fas fa-trash-alt me-1"></i> حذف
					</button>
				</form>
				<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
					<i class="fas fa-times me-1"></i> إلغاء
				</button>
			</div>
		</div>
	</div>
</div>

@functions {
	string GetStatusBadgeClass(OrderState status) => status switch
	{
		OrderState.Pending => "bg-warning",
		OrderState.Confirmed => "bg-info",
		OrderState.Shipping => "bg-primary",
		OrderState.Delivered => "bg-success",
		OrderState.Cancelled => "bg-danger",
		OrderState.Processing => "bg-secondary",
		OrderState.Returned => "bg-dark",
		_ => "bg-secondary"
	};

	string GetStatusText(OrderState status) => status switch
	{
		OrderState.Pending => "موقوف",
		OrderState.Confirmed => "مؤكد",
		OrderState.Shipping => "تم الشحن",
		OrderState.Delivered => "تم التسليم",
		OrderState.Cancelled => "ملغي",
		OrderState.Returned => "أرجاع",
		OrderState.Processing => "في الانتظار",
		_ => status.ToString()
	};
}

@section Scripts {
	<script>
		var deleteModal = document.getElementById('deleteModal');
		deleteModal.addEventListener('show.bs.modal', function (event) {
			var button = event.relatedTarget;
			var orderId = button.getAttribute('data-order-id');
			var orderUser = button.getAttribute('data-order-user');

			document.getElementById('deleteOrderId').textContent = "#" + orderId.padStart(6, "0");
			document.getElementById('deleteOrderUser').textContent = orderUser;
			document.getElementById('deleteInputId').value = orderId;

			document.getElementById('deleteForm').action = '/Order/Delete/' + orderId;
		});
	</script>
}
