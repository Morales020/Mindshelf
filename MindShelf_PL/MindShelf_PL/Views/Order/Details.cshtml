@using MindShelf_DAL.Models
@model MindShelf_BL.Dtos.OrderDtos.OrderResponseDto

@{
	ViewData["Title"] = "تفاصيل الطلب";
}

<div class="d-flex align-items-center mb-4 p-3">
	<h2 class="mb-0"><i class="fas fa-receipt me-2"></i> تفاصيل الطلب #@Model.Id.ToString().PadLeft(6, '0')</h2>
	<span class="badge @GetStatusBadgeClass(Model.OrderStatus) m-3 p-3 float-end">
		@GetStatusText(Model.OrderStatus)
	</span>

</div>


<div class="card mb-4">
	<div class="card-body">
		<dl class="row">
			<dt class="col-sm-3">تاريخ الطلب</dt>
			<dd class="col-sm-9">@Model.OrderDate.ToString("dd/MM/yyyy HH:mm")</dd>

			<dt class="col-sm-3">المستخدم</dt>
			<dd class="col-sm-9">@Model.UserName</dd>

			<dt class="col-sm-3">العنوان</dt>
			<dd class="col-sm-9">@Model.ShippingAddress</dd>

			<dt class="col-sm-3">الإجمالي</dt>
			<dd class="col-sm-9 fw-bold">@Model.TotalAmount.ToString("C")</dd>
		</dl>
	</div>
</div>

<!-- Items -->
<div class="card mb-4">
	<div class="card-header">
		<i class="fas fa-boxes me-2"></i> عناصر الطلب (@Model.OrderItems.Count)
	</div>
	<div class="card-body">
		@if (Model.OrderItems != null && Model.OrderItems.Any())
		{
			<div class="row">
				@foreach (var item in Model.OrderItems)
				{
					<div class="col-md-6 col-lg-4 mb-3">
						<div class="card h-100 border-0 shadow-sm order-item-card">
							<div class="card-body">
								<div class="d-flex justify-content-between align-items-start mb-2">
									<h6 class="card-title mb-0 text-truncate" style="max-width: 200px;" title="@item.BookName">
										@item.BookName
									</h6>
									<span class="badge bg-primary">#@item.BookId</span>
								</div>
								
								<div class="row text-muted small mb-2">
									<div class="col-6">
										<i class="fas fa-hashtag me-1"></i>
										<span>العنصر: @item.OrderItemId</span>
									</div>
									<div class="col-6">
										<i class="fas fa-shopping-cart me-1"></i>
										<span>الكمية: @item.Quantity</span>
									</div>
								</div>
								
								<div class="d-flex justify-content-between align-items-center">
									<div class="text-muted small">
										<span>السعر الوحدة:</span>
										<span class="fw-bold">@item.Price.ToString("C")</span>
									</div>
									<div class="text-success fw-bold">
										<i class="fas fa-calculator me-1"></i>
										@item.TotalPrice.ToString("C")
									</div>
								</div>
							</div>
						</div>
					</div>
				}
			</div>
			
			<!-- Summary Table -->
			<div class="mt-4">
				<div class="card bg-light">
					<div class="card-body">
						<h6 class="card-title mb-3">
							<i class="fas fa-list-alt me-2"></i> ملخص الطلب
						</h6>
						<div class="table-responsive">
							<table class="table table-sm mb-0">
								<thead class="table-light">
									<tr>
										<th>اسم الكتاب</th>
										<th class="text-center">الكمية</th>
										<th class="text-center">السعر الوحدة</th>
										<th class="text-end">المجموع</th>
									</tr>
								</thead>
								<tbody>
									@foreach (var item in Model.OrderItems)
									{
										<tr>
											<td class="text-truncate" style="max-width: 250px;" title="@item.BookName">
												@item.BookName
											</td>
											<td class="text-center">@item.Quantity</td>
											<td class="text-center">@item.Price.ToString("C")</td>
											<td class="text-end fw-bold">@item.TotalPrice.ToString("C")</td>
										</tr>
									}
								</tbody>
								<tfoot class="table-light">
									<tr>
										<th colspan="3" class="text-end">المجموع الكلي:</th>
										<th class="text-end text-success">@Model.TotalAmount.ToString("C")</th>
									</tr>
								</tfoot>
							</table>
						</div>
					</div>
				</div>
			</div>
		}
		else
		{
			<div class="text-center py-5">
				<i class="fas fa-box-open fa-3x text-muted mb-3"></i>
				<p class="text-muted fs-5">لا توجد عناصر في هذا الطلب.</p>
			</div>
		}
	</div>
</div>

<!-- Actions -->
<div class="d-flex justify-content-between p-2">
	@if (User.IsInRole("Admin"))
	{
		<a asp-action="Index" class="btn btn-secondary">
			<i class="fas fa-arrow-left me-1"></i> رجوع للطلبات
		</a>
	}
	else
	{
		<a asp-action="UserOrders" asp-route-userName="@User.Identity.Name" class="btn btn-secondary">
			<i class="fas fa-arrow-left me-1"></i> رجوع لطلباتي
		</a>
	}

	@if (Model.OrderStatus == MindShelf_DAL.Models.OrderState.Pending)
	{
		<form asp-action="Cancel" method="post" asp-route-id="@Model.Id" class="d-inline">
			<button type="submit" class="btn btn-danger">
				<i class="fas fa-times me-1"></i> إلغاء الطلب
			</button>
		</form>
	}
</div>


@functions {
	string GetStatusBadgeClass(OrderState status) => status switch
    {
        OrderState.Pending => "bg-warning",
        OrderState.Confirmed => "bg-info",
        OrderState.Shipping => "bg-primary",
        OrderState.Delivered => "bg-success",
        OrderState.Cancelled => "bg-danger",
        OrderState.Processing => "bg-secondary",
        OrderState.Returned => "bg-dark",
        _ => "bg-secondary"
    };

    string GetStatusText(OrderState status) => status switch
    {
        OrderState.Pending => "موقوف",
        OrderState.Confirmed => "مؤكد",
        OrderState.Shipping => "تم الشحن",
        OrderState.Delivered => "تم التسليم",
        OrderState.Cancelled => "ملغي",
        OrderState.Returned => "أرجاع",
        OrderState.Processing => "في الانتظار",
        _ => status.ToString()
    };
}
